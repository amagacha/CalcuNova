<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>CalcuNova</title>
<style>
body{
    margin:0;
    font-family:sans-serif;
    background:#f0f4f8;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    flex-direction:column;
}
.hidden{display:none;}
h1{font-size:3rem;margin-bottom:20px;}
button{
    font-size:1.2rem;
    margin:5px;
    padding:10px 15px;
    border-radius:10px;
    border:none;
    background:#4CAF50;
    color:white;
    cursor:pointer;
}
button:hover{background:#45a049;}
#question{font-size:2rem;margin:15px;}
#answer{
    font-size:2rem;
    width:150px;
    text-align:center;
}
#keypad{
    display:grid;
    grid-template-columns:repeat(3,70px);
    gap:10px;
    justify-content:center;
    margin:15px;
}
#version{
    position:absolute;
    bottom:10px;
    right:10px;
    font-size:0.8rem;
    color:gray;
}
</style>
</head>
<body>

<div id="home">
<h1>CalcuNova</h1>
<p>学年を選んでスタート</p>
<div id="gradeButtons"></div>
<div id="version">V0.0.0</div>
</div>

<div id="game" class="hidden">
<div id="timer"></div>
<div id="score"></div>
<div id="question"></div>
<input id="answer" readonly>
<div id="keypad"></div>
<button onclick="checkAnswer()">決定</button>
</div>

<div id="result" class="hidden">
<h2>結果</h2>
<div id="finalScore"></div>
<button onclick="backHome()">ホームへ</button>
</div>

<script>
let currentGrade=1;
let score=0;
let timeLeft=0;
let timer;
let correctAnswer=0;

/* ===== 学年ボタン生成 ===== */
for(let i=1;i<=6;i++){
    const btn=document.createElement("button");
    btn.textContent=i+"年生";
    btn.onclick=()=>startGame(i);
    document.getElementById("gradeButtons").appendChild(btn);
}

/* ===== キーパッド ===== */
function createKeypad(){
    const keypad=document.getElementById("keypad");
    keypad.innerHTML="";
    for(let i=1;i<=9;i++){
        const b=document.createElement("button");
        b.textContent=i;
        b.onclick=()=>document.getElementById("answer").value+=i;
        keypad.appendChild(b);
    }
    const zero=document.createElement("button");
    zero.textContent="0";
    zero.onclick=()=>document.getElementById("answer").value+="0";
    keypad.appendChild(zero);

    const clear=document.createElement("button");
    clear.textContent="C";
    clear.onclick=()=>document.getElementById("answer").value="";
    keypad.appendChild(clear);
}

/* ===== スタート ===== */
function startGame(grade){
    currentGrade=grade;
    score=0;
    timeLeft=grade*30;

    document.getElementById("home").classList.add("hidden");
    document.getElementById("game").classList.remove("hidden");

    document.getElementById("score").textContent="Score: 0";
    document.getElementById("timer").textContent="Time: "+timeLeft;

    createKeypad();
    newQuestion();
    startTimer();
}

/* ===== タイマー ===== */
function startTimer(){
    clearInterval(timer);
    timer=setInterval(()=>{
        timeLeft--;
        document.getElementById("timer").textContent="Time: "+timeLeft;
        if(timeLeft<=0){
            clearInterval(timer);
            endGame();
        }
    },1000);
}

/* ===== 問題生成（絶対マイナスなし） ===== */
function newQuestion(){
    let a,b,c,op1,op2;

    if(currentGrade===1){
        op1=Math.random()<0.5?"+":"-";
        a=random(1,9);
        b=random(1,9);
        if(op1==="-" && b>a){ [a,b]=[b,a]; }
        correctAnswer=op1==="+"?a+b:a-b;
        show(a,op1,b);

    }else if(currentGrade===2){
        const r=Math.random();
        if(r<0.4){
            a=random(1,100);
            b=random(1,100);
            correctAnswer=a+b;
            show(a,"+",b);
        }else if(r<0.8){
            a=random(1,100);
            b=random(1,100);
            if(b>a){[a,b]=[b,a];}
            correctAnswer=a-b;
            show(a,"-",b);
        }else{
            a=random(1,9);
            b=random(1,9);
            correctAnswer=a*b;
            show(a,"×",b);
        }

    }else{
        // 3〜6年生
        op1=randomOp();
        op2=randomOp();
        a=random(1,20);
        b=random(1,20);
        c=random(1,20);

        // 割り算は割り切れるように
        if(op1==="÷"){
            b=random(1,9);
            correctAnswer=random(1,20);
            a=b*correctAnswer;
        }

        let expr=a+convert(op1)+b;

        let temp=eval(expr);

        if(op2==="÷"){
            c=random(1,9);
            let result=random(1,20);
            temp=c*result;
            correctAnswer=result;
            show(temp,"÷",c);
            return;
        }

        if(op2==="-"){
            if(c>temp){ c=random(1,temp); }
        }

        correctAnswer=eval(temp+convert(op2)+c);
        show(temp,op2,c);
    }

    document.getElementById("answer").value="";
}

function show(x,o,y){
    document.getElementById("question").textContent=x+" "+o+" "+y;
}

function random(min,max){
    return Math.floor(Math.random()*(max-min+1))+min;
}

function randomOp(){
    const ops=["+","-","×","÷"];
    return ops[random(0,3)];
}

function convert(op){
    if(op==="×") return "*";
    if(op==="÷") return "/";
    return op;
}

/* ===== 判定 ===== */
function checkAnswer(){
    const input=Number(document.getElementById("answer").value);
    if(input===correctAnswer){
        score++;
        document.getElementById("score").textContent="Score: "+score;
    }
    newQuestion();
}

/* ===== 終了 ===== */
function endGame(){
    document.getElementById("game").classList.add("hidden");
    document.getElementById("result").classList.remove("hidden");
    document.getElementById("finalScore").textContent="スコア: "+score;
}

function backHome(){
    document.getElementById("result").classList.add("hidden");
    document.getElementById("home").classList.remove("hidden");
}
</script>

</body>
</html>